<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>El Tresor Amagat</title>
  <style>
    :root {
      --bg: #0b1221;
      --fg: #e6eef8;
      --accent: #3fd1c7;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f1c40f;
      --skull: #ecf0f1;
      --chest: #d35400;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: var(--fg);
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 20px;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 10px;
    }
    
    h1 {
      font-size: 3rem;
      background: linear-gradient(90deg, var(--accent), var(--warning));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(63, 209, 199, 0.3);
    }
    
    .subtitle {
      font-size: 1.1rem;
      color: rgba(230, 238, 248, 0.7);
      font-style: italic;
    }
    
    .difficulty-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .difficulty-btn {
      background: rgba(11, 18, 33, 0.8);
      border: 2px solid rgba(63, 209, 199, 0.3);
      border-radius: 8px;
      padding: 12px 25px;
      color: var(--fg);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .difficulty-btn:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
    }
    
    .difficulty-btn.active {
      background: rgba(63, 209, 199, 0.2);
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(63, 209, 199, 0.3);
    }
    
    .stats-panel {
      display: flex;
      justify-content: space-between;
      width: 100%;
      background: rgba(11, 18, 33, 0.8);
      border: 2px solid rgba(63, 209, 199, 0.2);
      border-radius: 12px;
      padding: 15px 25px;
      backdrop-filter: blur(10px);
    }
    
    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: rgba(230, 238, 248, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #timeValue {
      color: var(--accent);
    }
    
    #scoreValue {
      color: var(--warning);
    }
    
    #levelValue {
      color: var(--success);
    }
    
    #livesValue {
      color: var(--danger);
    }
    
    .game-area {
      position: relative;
      width: 100%;
    }
    
    canvas {
      display: block;
      background: #0a1832;
      border: 3px solid rgba(63, 209, 199, 0.2);
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 800px;
      height: 500px;
      margin: 0 auto;
      image-rendering: -moz-crisp-edges;
      image-rendering: -webkit-crisp-edges;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    
    .controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
      width: 100%;
    }
    
    .instructions {
      text-align: center;
      color: rgba(230, 238, 248, 0.7);
      font-size: 1rem;
      background: rgba(7, 16, 39, 0.5);
      padding: 12px 20px;
      border-radius: 8px;
      border-left: 3px solid var(--accent);
      width: 100%;
      max-width: 600px;
    }
    
    .key-instructions {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .key {
      background: rgba(63, 209, 199, 0.1);
      border: 2px solid var(--accent);
      border-radius: 6px;
      padding: 8px 15px;
      font-weight: bold;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(5, 10, 20, 0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .modal {
      background: linear-gradient(145deg, rgba(11, 18, 33, 0.95), rgba(7, 16, 39, 0.95));
      border: 3px solid var(--accent);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      animation: modalAppear 0.5s ease-out;
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal h2 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      text-shadow: 0 0 15px currentColor;
    }
    
    .win-modal h2 {
      color: var(--success);
    }
    
    .lose-modal h2 {
      color: var(--danger);
    }
    
    .modal p {
      font-size: 1.2rem;
      color: rgba(230, 238, 248, 0.9);
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .final-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 30px 0;
    }
    
    .final-stat {
      background: rgba(63, 209, 199, 0.1);
      border-radius: 10px;
      padding: 15px;
      border: 1px solid rgba(63, 209, 199, 0.2);
    }
    
    .final-stat-value {
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .final-stat-label {
      font-size: 0.9rem;
      color: rgba(230, 238, 248, 0.6);
      text-transform: uppercase;
    }
    
    .btn {
      background: linear-gradient(90deg, var(--accent), #2ab7a9);
      border: none;
      border-radius: 10px;
      padding: 15px 40px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #022;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      box-shadow: 0 5px 15px rgba(63, 209, 199, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(63, 209, 199, 0.5);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-danger {
      background: linear-gradient(90deg, var(--danger), #c0392b);
    }
    
    .celebration {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }
    
    .skull-emoji {
      animation: float 3s infinite ease-in-out;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(5deg); }
    }
    
    .difficulty-indicator {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(11, 18, 33, 0.8);
      border: 1px solid rgba(63, 209, 199, 0.3);
      border-radius: 8px;
      padding: 8px 15px;
      font-size: 0.9rem;
      color: var(--fg);
    }
    
    .difficulty-value {
      color: var(--accent);
      font-weight: 700;
    }
    
    .legend {
      display: flex;
      gap: 20px;
      margin-top: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: rgba(230, 238, 248, 0.7);
    }
    
    .legend-emoji {
      font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
      h1 {
        font-size: 2.2rem;
      }
      
      canvas {
        height: 400px;
      }
      
      .stats-panel {
        flex-direction: column;
        gap: 15px;
      }
      
      .stat-item {
        flex-direction: row;
        justify-content: space-between;
      }
      
      .key-instructions {
        flex-wrap: wrap;
      }
      
      .difficulty-selector {
        flex-direction: column;
        align-items: center;
      }
      
      .difficulty-btn {
        width: 200px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>El Tresor Amagat üè¥‚Äç‚ò†Ô∏è</h1>
      <p class="subtitle">Recull el tresor i escapa de les calaveres!</p>
    </header>
    
    <div class="difficulty-selector">
      <button class="difficulty-btn active" data-difficulty="easy">
        <span>üòä</span> F√†cil
      </button>
      <button class="difficulty-btn" data-difficulty="normal">
        <span>üòê</span> Normal
      </button>
      <button class="difficulty-btn" data-difficulty="hard">
        <span>üò∞</span> Dif√≠cil
      </button>
      <button class="difficulty-btn" data-difficulty="expert">
        <span>üòà</span> Expert
      </button>
    </div>
    
    <div class="stats-panel">
      <div class="stat-item">
        <span class="stat-label">Temps</span>
        <span class="stat-value" id="timeValue">‚è±Ô∏è 0s</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Tresors</span>
        <span class="stat-value" id="scoreValue">üèÜ 0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Nivell</span>
        <span class="stat-value" id="levelValue">üìà 1</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Vides</span>
        <span class="stat-value" id="livesValue">‚ù§Ô∏è 3</span>
      </div>
    </div>
    
    <div class="game-area">
      <canvas id="gameCanvas"></canvas>
      <div class="difficulty-indicator">
        Dificultat: <span class="difficulty-value" id="difficultyValue">F√†cil</span>
      </div>
    </div>
    
    <div class="legend">
      <div class="legend-item">
        <span class="legend-emoji">üßç</span> Tu
      </div>
      <div class="legend-item">
        <span class="legend-emoji">üéÅ</span> Cofre del tresor
      </div>
      <div class="legend-item">
        <span class="legend-emoji">üíÄ</span> Calavera
      </div>
      <div class="legend-item">
        <span class="legend-emoji">‚ù§Ô∏è</span> Vida
      </div>
    </div>
    
    <div class="controls">
      <div class="instructions">
        <p>üí° Usa les fletxes del teclat per moure't!</p>
        <div class="key-instructions">
          <div class="key">‚Üë Anar amunt</div>
          <div class="key">‚Üì Anar avall</div>
          <div class="key">‚Üê Anar esquerra</div>
          <div class="key">‚Üí Anar dreta</div>
        </div>
        <p style="margin-top: 10px; color: var(--danger);">‚ö†Ô∏è Evita les calaveres! Si et toquen, perds una vida.</p>
      </div>
    </div>
  </div>
  
  <!-- Overlay de victoria -->
  <div class="overlay win-modal" id="winOverlay">
    <div class="modal">
      <div class="celebration">üèÜüéâ‚ú®</div>
      <h2>Has Guanyat! üéä</h2>
      <p id="resultMessage">Has completat tots els nivells amb √®xit!</p>
      
      <div class="final-stats">
        <div class="final-stat">
          <div class="final-stat-value">üìà <span id="finalLevel">1</span></div>
          <div class="final-stat-label">Nivell Final</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-value">üèÜ <span id="finalScore">0</span></div>
          <div class="final-stat-label">Tresors</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-value">‚è±Ô∏è <span id="finalTime">0s</span></div>
          <div class="final-stat-label">Temps</div>
        </div>
      </div>
      
      <button class="btn" id="restartBtn">
        <span>üîÑ</span> Jugar de Nou
      </button>
    </div>
  </div>
  
  <!-- Overlay de derrota -->
  <div class="overlay lose-modal" id="loseOverlay">
    <div class="modal">
      <div class="celebration">üíÄ‚ò†Ô∏èüòµ</div>
      <h2>Has Perdut! üò¢</h2>
      <p id="loseMessage">Les calaveres t'han atrapat...</p>
      
      <div class="final-stats">
        <div class="final-stat">
          <div class="final-stat-value">üìà <span id="loseLevel">1</span></div>
          <div class="final-stat-label">Nivell</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-value">üèÜ <span id="loseScore">0</span></div>
          <div class="final-stat-label">Tresors</div>
        </div>
        <div class="final-stat">
          <div class="final-stat-value">‚è±Ô∏è <span id="loseTime">0s</span></div>
          <div class="final-stat-label">Temps</div>
        </div>
      </div>
      
      <button class="btn" id="restartLoseBtn">
        <span>üîÑ</span> Intentar-ho de Nou
      </button>
    </div>
  </div>

  <script>
    // ===== CONFIGURACI√ìN DEL JUEGO =====
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Asegurarnos de que el canvas est√© completamente limpio
    canvas.width = 800;
    canvas.height = 500;
    
    // Limpiar completamente el canvas antes de empezar
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // ===== VARIABLES DEL JUEGO =====
    let gameRunning = true;
    let score = 0;
    let level = 1;
    let lives = 3;
    let startTime = Date.now();
    let elapsedTime = 0;
    let difficulty = 'easy';
    let maxLevel = 5;
    let lastFrameTime = 0;
    const frameRate = 60;
    const frameInterval = 1000 / frameRate;
    
    // ===== CONFIGURACIONES DE DIFICULTAD =====
    const difficultySettings = {
      easy: {
        playerSpeed: 4,
        skullSpeed: 1.5,
        skullCount: 2,
        maxSkulls: 4,
        lives: 5
      },
      normal: {
        playerSpeed: 5,
        skullSpeed: 2,
        skullCount: 3,
        maxSkulls: 5,
        lives: 4
      },
      hard: {
        playerSpeed: 5.5,
        skullSpeed: 2.5,
        skullCount: 4,
        maxSkulls: 6,
        lives: 3
      },
      expert: {
        playerSpeed: 6,
        skullSpeed: 3,
        skullCount: 5,
        maxSkulls: 8,
        lives: 2
      }
    };
    
    // ===== ELEMENTOS DE LA INTERFAZ =====
    const timeValue = document.getElementById('timeValue');
    const scoreValue = document.getElementById('scoreValue');
    const levelValue = document.getElementById('levelValue');
    const livesValue = document.getElementById('livesValue');
    const difficultyValue = document.getElementById('difficultyValue');
    const winOverlay = document.getElementById('winOverlay');
    const loseOverlay = document.getElementById('loseOverlay');
    const resultMessage = document.getElementById('resultMessage');
    const loseMessage = document.getElementById('loseMessage');
    const finalLevel = document.getElementById('finalLevel');
    const finalScore = document.getElementById('finalScore');
    const finalTime = document.getElementById('finalTime');
    const loseLevel = document.getElementById('loseLevel');
    const loseScore = document.getElementById('loseScore');
    const loseTime = document.getElementById('loseTime');
    const restartBtn = document.getElementById('restartBtn');
    const restartLoseBtn = document.getElementById('restartLoseBtn');
    const difficultyBtns = document.querySelectorAll('.difficulty-btn');
    
    // ===== JUGADOR =====
    const player = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      size: 30,
      speed: 5,
      emoji: 'üßç',
      dx: 0,
      dy: 0
    };
    
    // ===== TESORO =====
    let treasure = {
      x: 100,
      y: 100,
      size: 35,
      emoji: 'üéÅ',
      vx: 0,
      vy: 0,
      glow: 0,
      glowDirection: 1
    };
    
    // ===== CALAVERAS =====
    let skulls = [];
    
    // ===== PART√çCULAS PARA EFECTOS =====
    let particles = [];
    const MAX_PARTICLES = 80; // L√≠mite de part√≠culas para evitar lag
    
    // ===== FUNCIONES DEL JUEGO =====
    
    // Inicializar juego con dificultad
    function initGame() {
      const settings = difficultySettings[difficulty];
      player.speed = settings.playerSpeed;
      lives = settings.lives;
      
      // Actualizar interfaz
      livesValue.textContent = `‚ù§Ô∏è ${lives}`;
      difficultyValue.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
      
      // Limpiar arrays
      skulls = [];
      particles = [];
      
      // Generar calaveras iniciales
      generateSkulls();
      
      // Generar tesoro
      generateTreasure();
      
      // Posicionar jugador
      player.x = canvas.width / 2;
      player.y = canvas.height / 2;
      player.dx = 0;
      player.dy = 0;
      
      // Resetear tiempo
      startTime = Date.now();
      elapsedTime = 0;
      lastFrameTime = 0;
      
      // Limpiar canvas completamente
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    
    // Generar calaveras
    function generateSkulls() {
      const settings = difficultySettings[difficulty];
      const baseCount = settings.skullCount + Math.floor((level - 1) / 2);
      const skullCount = Math.min(baseCount, settings.maxSkulls);
      
      for (let i = 0; i < skullCount; i++) {
        const side = Math.floor(Math.random() * 4);
        let x, y;
        
        switch(side) {
          case 0: // Arriba
            x = Math.random() * canvas.width;
            y = -50;
            break;
          case 1: // Derecha
            x = canvas.width + 50;
            y = Math.random() * canvas.height;
            break;
          case 2: // Abajo
            x = Math.random() * canvas.width;
            y = canvas.height + 50;
            break;
          case 3: // Izquierda
            x = -50;
            y = Math.random() * canvas.height;
            break;
        }
        
        skulls.push({
          x: x,
          y: y,
          size: 28,
          speed: settings.skullSpeed + (level - 1) * 0.2,
          emoji: 'üíÄ',
          rotation: 0,
          rotationSpeed: (Math.random() - 0.5) * 0.05
        });
      }
    }
    
    // Generar nuevo tesoro
    function generateTreasure() {
      const padding = 60;
      const newSize = 35;
      
      treasure = {
        x: padding + Math.random() * (canvas.width - 2 * padding),
        y: padding + Math.random() * (canvas.height - 2 * padding),
        size: newSize,
        emoji: 'üéÅ',
        vx: 0,
        vy: 0,
        glow: 0,
        glowDirection: 1
      };
      
      // El tesoro se mueve a partir del nivel 3
      if (level >= 3) {
        const speed = 0.8 + (level - 3) * 0.4;
        treasure.vx = (Math.random() * 2 - 1) * speed;
        treasure.vy = (Math.random() * 2 - 1) * speed;
      }
      
      // Crear part√≠culas para efecto de aparici√≥n (con l√≠mite)
      createParticles(treasure.x, treasure.y, 8, '#f1c40f');
    }
    
    // Crear part√≠culas con l√≠mite
    function createParticles(x, y, count, color) {
      // Eliminar part√≠culas viejas si estamos cerca del l√≠mite
      if (particles.length > MAX_PARTICLES - count) {
        particles.splice(0, count);
      }
      
      for (let i = 0; i < count; i++) {
        particles.push({
          x: x,
          y: y,
          size: Math.random() * 4 + 2,
          color: color || (Math.random() > 0.5 ? '#3fd1c7' : '#f1c40f'),
          speedX: (Math.random() - 0.5) * 5,
          speedY: (Math.random() - 0.5) * 5,
          life: 15 + Math.random() * 15, // Vida m√°s corta
          emoji: Math.random() > 0.7 ? '‚ú®' : '‚≠ê'
        });
      }
    }
    
    // Actualizar part√≠culas
    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].x += particles[i].speedX;
        particles[i].y += particles[i].speedY;
        particles[i].life -= 1;
        
        if (particles[i].life <= 0) {
          particles.splice(i, 1);
        }
      }
    }
    
    // Actualizar posici√≥n del jugador
    function updatePlayer() {
      player.x += player.dx;
      player.y += player.dy;
      
      // Mantener dentro del canvas
      player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
      player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
    }
    
    // Actualizar calaveras
    function updateSkulls() {
      skulls.forEach(skull => {
        // Seguir al jugador
        const dx = player.x - skull.x;
        const dy = player.y - skull.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance > 0) {
          skull.x += (dx / distance) * skull.speed;
          skull.y += (dy / distance) * skull.speed;
        }
        
        // Rotaci√≥n
        skull.rotation += skull.rotationSpeed;
        
        // Verificar colisi√≥n con jugador
        const playerDistance = Math.sqrt(
          Math.pow(player.x - skull.x, 2) + Math.pow(player.y - skull.y, 2)
        );
        
        if (playerDistance < player.size + skull.size) {
          loseLife();
          // Reposicionar calavera despu√©s de golpear
          skull.x = -100;
          skull.y = -100;
        }
      });
    }
    
    // Actualizar tesoro
    function updateTreasure() {
      // Actualizar efecto de brillo
      treasure.glow += 0.05 * treasure.glowDirection;
      if (treasure.glow >= 1) treasure.glowDirection = -1;
      if (treasure.glow <= 0) treasure.glowDirection = 1;
      
      // Mover tesoro si tiene velocidad
      if (treasure.vx !== 0 || treasure.vy !== 0) {
        treasure.x += treasure.vx;
        treasure.y += treasure.vy;
        
        // Rebotar en los bordes
        const padding = 40;
        if (treasure.x < padding || treasure.x > canvas.width - padding) {
          treasure.vx *= -1;
        }
        if (treasure.y < padding || treasure.y > canvas.height - padding) {
          treasure.vy *= -1;
        }
        
        // Asegurar que no salga del canvas
        treasure.x = Math.max(padding, Math.min(canvas.width - padding, treasure.x));
        treasure.y = Math.max(padding, Math.min(canvas.height - padding, treasure.y));
      }
    }
    
    // Verificar colisi√≥n con tesoro
    function checkTreasureCollision() {
      const dx = player.x - treasure.x;
      const dy = player.y - treasure.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      const minDistance = player.size + treasure.size;
      
      if (distance < minDistance) {
        // ¬°Tesoro encontrado!
        collectTreasure();
      }
    }
    
    // Recoger tesoro (funci√≥n separada para mejor control)
    function collectTreasure() {
      score++;
      level++;
      
      // Actualizar interfaz
      scoreValue.textContent = `üèÜ ${score}`;
      levelValue.textContent = `üìà ${level}`;
      
      // Efecto de part√≠culas (con l√≠mite)
      createParticles(treasure.x, treasure.y, 12, '#f1c40f');
      
      // Verificar si se ha ganado
      if (level > maxLevel) {
        endGame(true);
        return;
      }
      
      // A√±adir calavera cada 2 niveles
      if (level % 2 === 0 && skulls.length < difficultySettings[difficulty].maxSkulls) {
        addSkull();
      }
      
      // Generar nuevo tesoro
      generateTreasure();
      
      // Peque√±o movimiento para evitar m√∫ltiples colisiones
      player.x += 5;
      player.y += 5;
    }
    
    // A√±adir nueva calavera
    function addSkull() {
      const side = Math.floor(Math.random() * 4);
      let x, y;
      
      switch(side) {
        case 0: x = -50; y = Math.random() * canvas.height; break;
        case 1: x = canvas.width + 50; y = Math.random() * canvas.height; break;
        case 2: x = Math.random() * canvas.width; y = -50; break;
        case 3: x = Math.random() * canvas.width; y = canvas.height + 50; break;
      }
      
      skulls.push({
        x: x,
        y: y,
        size: 28,
        speed: difficultySettings[difficulty].skullSpeed + (level - 1) * 0.2,
        emoji: 'üíÄ',
        rotation: 0,
        rotationSpeed: (Math.random() - 0.5) * 0.05
      });
    }
    
    // Perder vida
    function loseLife() {
      lives--;
      livesValue.textContent = `‚ù§Ô∏è ${lives}`;
      
      // Efecto de part√≠culas rojas (con l√≠mite)
      createParticles(player.x, player.y, 8, '#e74c3c');
      
      // Reposicionar jugador
      player.x = canvas.width / 2;
      player.y = canvas.height / 2;
      
      // Verificar si se ha perdido
      if (lives <= 0) {
        setTimeout(() => {
          endGame(false);
        }, 300);
      }
    }
    
    // Actualizar tiempo
    function updateTime() {
      if (gameRunning) {
        elapsedTime = Math.floor((Date.now() - startTime) / 1000);
        timeValue.textContent = `‚è±Ô∏è ${elapsedTime}s`;
      }
    }
    
    // Dibujar fondo
    function drawBackground() {
      // Fondo base - LIMPIAR COMPLETAMENTE primero
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#0a1832';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Rejilla sutil
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
      ctx.lineWidth = 1;
      
      for (let x = 0; x < canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      
      for (let y = 0; y < canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }
    
    // Dibujar tesoro
    function drawTreasure() {
      // Halo de brillo
      const glowRadius = treasure.size * 2 + treasure.glow * 20;
      const gradient = ctx.createRadialGradient(
        treasure.x, treasure.y, treasure.size,
        treasure.x, treasure.y, glowRadius
      );
      gradient.addColorStop(0, `rgba(241, 196, 15, ${0.5 + treasure.glow * 0.3})`);
      gradient.addColorStop(1, 'rgba(241, 196, 15, 0)');
      
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.arc(treasure.x, treasure.y, glowRadius, 0, Math.PI * 2);
      ctx.fill();
      
      // Dibujar emoji del cofre
      ctx.font = `bold ${treasure.size}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#f1c40f';
      ctx.fillText(treasure.emoji, treasure.x, treasure.y);
    }
    
    // Dibujar jugador
    function drawPlayer() {
      // Aura del jugador
      ctx.strokeStyle = 'rgba(63, 209, 199, 0.4)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(player.x, player.y, player.size + 15, 0, Math.PI * 2);
      ctx.stroke();
      
      // Dibujar emoji del jugador
      ctx.font = `${player.size}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillStyle = '#3fd1c7';
      ctx.fillText(player.emoji, player.x, player.y);
    }
    
    // Dibujar calaveras
    function drawSkulls() {
      skulls.forEach(skull => {
        // Aura roja de peligro
        ctx.strokeStyle = 'rgba(231, 76, 60, 0.3)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(skull.x, skull.y, skull.size + 10, 0, Math.PI * 2);
        ctx.stroke();
        
        // Dibujar emoji de calavera con rotaci√≥n
        ctx.save();
        ctx.translate(skull.x, skull.y);
        ctx.rotate(skull.rotation);
        ctx.font = `${skull.size}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#ecf0f1';
        ctx.fillText(skull.emoji, 0, 0);
        ctx.restore();
      });
    }
    
    // Dibujar part√≠culas
    function drawParticles() {
      particles.forEach(p => {
        ctx.globalAlpha = p.life / 30;
        ctx.font = `${p.size * 3}px "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", sans-serif`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = p.color;
        ctx.fillText(p.emoji || '‚ú®', p.x, p.y);
      });
      ctx.globalAlpha = 1;
    }
    
    // Finalizar juego
    function endGame(isWin) {
      gameRunning = false;
      
      if (isWin) {
        // Victoria
        finalLevel.textContent = level - 1;
        finalScore.textContent = score;
        finalTime.textContent = elapsedTime + 's';
        
        // Mensaje personalizado
        let message;
        if (elapsedTime < 40) {
          message = "üöÄ Incre√Øble! Has completat el joc en un temps r√®cord!";
        } else if (elapsedTime < 80) {
          message = "üéØ Excel¬∑lent! Has evitat les calaveres amb habilitat!";
        } else {
          message = "üëç Ben fet! Has superat tots els reptes!";
        }
        resultMessage.textContent = message;
        
        winOverlay.style.display = 'flex';
      } else {
        // Derrota
        loseLevel.textContent = level;
        loseScore.textContent = score;
        loseTime.textContent = elapsedTime + 's';
        
        // Mensaje personalizado
        let message;
        if (score === 0) {
          message = "üòÖ No has trobat cap tresor... Torna-ho a intentar!";
        } else if (score < 3) {
          message = "üí™ Est√†s millorant! Les calaveres s√≥n tra√Ødores...";
        } else {
          message = "üëè Bona actuaci√≥! Has trobat " + score + " tresors!";
        }
        loseMessage.textContent = message;
        
        loseOverlay.style.display = 'flex';
      }
    }
    
    // Reiniciar juego
    function restartGame() {
      gameRunning = true;
      score = 0;
      level = 1;
      startTime = Date.now();
      elapsedTime = 0;
      particles = [];
      skulls = [];
      
      // Actualizar interfaz
      scoreValue.textContent = `üèÜ ${score}`;
      levelValue.textContent = `üìà ${level}`;
      timeValue.textContent = `‚è±Ô∏è 0s`;
      
      // Inicializar juego con la dificultad actual
      initGame();
      
      // Ocultar overlays
      winOverlay.style.display = 'none';
      loseOverlay.style.display = 'none';
    }
    
    // Cambiar dificultad
    function changeDifficulty(newDifficulty) {
      difficulty = newDifficulty;
      
      // Actualizar botones activos
      difficultyBtns.forEach(btn => {
        if (btn.dataset.difficulty === newDifficulty) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      
      // Reiniciar juego con nueva dificultad
      restartGame();
    }
    
    // Bucle principal del juego optimizado
    function gameLoop(timestamp) {
      if (!gameRunning) {
        requestAnimationFrame(gameLoop);
        return;
      }
      
      // Control de FPS para evitar lag
      if (timestamp - lastFrameTime < frameInterval) {
        requestAnimationFrame(gameLoop);
        return;
      }
      
      lastFrameTime = timestamp;
      
      // Actualizar
      updatePlayer();
      updateTreasure();
      updateSkulls();
      updateParticles();
      checkTreasureCollision();
      updateTime();
      
      // Dibujar
      drawBackground();
      drawParticles();
      drawTreasure();
      drawSkulls();
      drawPlayer();
      
      // Continuar bucle
      requestAnimationFrame(gameLoop);
    }
    
    // ===== CONTROLES =====
    
    // Controles de teclado
    document.addEventListener('keydown', (e) => {
      if (!gameRunning) return;
      
      switch(e.key) {
        case 'ArrowUp':
          player.dy = -player.speed;
          e.preventDefault();
          break;
        case 'ArrowDown':
          player.dy = player.speed;
          e.preventDefault();
          break;
        case 'ArrowLeft':
          player.dx = -player.speed;
          e.preventDefault();
          break;
        case 'ArrowRight':
          player.dx = player.speed;
          e.preventDefault();
          break;
      }
    });
    
    document.addEventListener('keyup', (e) => {
      switch(e.key) {
        case 'ArrowUp':
        case 'ArrowDown':
          player.dy = 0;
          break;
        case 'ArrowLeft':
        case 'ArrowRight':
          player.dx = 0;
          break;
      }
    });
    
    // Controles t√°ctiles para m√≥viles
    let touchStartX = 0;
    let touchStartY = 0;
    let isTouching = false;
    
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (e.touches.length === 1) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        isTouching = true;
      }
    }, { passive: false });
    
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!gameRunning || !isTouching || e.touches.length !== 1) return;
      
      const touchX = e.touches[0].clientX;
      const touchY = e.touches[0].clientY;
      
      const dx = touchX - touchStartX;
      const dy = touchY - touchStartY;
      
      // Normalizar velocidad
      const distance = Math.sqrt(dx * dx + dy * dy);
      if (distance > 5) {
        player.dx = (dx / distance) * player.speed * 1.2;
        player.dy = (dy / distance) * player.speed * 1.2;
        touchStartX = touchX;
        touchStartY = touchY;
      }
    }, { passive: false });
    
    canvas.addEventListener('touchend', () => {
      isTouching = false;
      player.dx = 0;
      player.dy = 0;
    });
    
    // ===== INICIALIZACI√ìN =====
    
    // Configurar botones de dificultad
    difficultyBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        changeDifficulty(btn.dataset.difficulty);
      });
    });
    
    // Configurar botones de reinicio
    restartBtn.addEventListener('click', restartGame);
    restartLoseBtn.addEventListener('click', restartGame);
    
    // Inicializar juego
    initGame();
    
    // Iniciar bucle del juego
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>